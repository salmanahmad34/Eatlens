<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EatLens - AI Nutrition Analysis & Meal Planning</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- jsPDF and html2canvas for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #10B981; /* Modern Green */
            --primary-dark: #059669;
            --primary-light: #A7F3D0;
            --secondary: #3B82F6; /* Blue */
            --secondary-light: #BFDBFE;
            --accent: #F59E0B; /* Yellow/Amber */
            --accent-light: #FDE68A;
            --danger: #EF4444; /* Red */
            --text-dark: #1F2937; /* Dark Gray */
            --text-light: #6B7280; /* Medium Gray */
            --background: #F9FAFB; /* Lightest Gray */
            --white: #FFFFFF;
            --border-color: #E5E7EB;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --hover-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        html {
            scroll-behavior: smooth;
        }

        .container {
            width: 100%;
            max-width: 1280px; /* Wider container */
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Page Wrapper */
        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Main Content */
        .main-content {
            flex-grow: 1;
        }

        /* Header */
        header {
            background-color: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            position: sticky;
            top: 0;
            z-index: 100;
            animation: slideDown 0.5s ease-out;
            border-bottom: 1px solid var(--border-color);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-dark);
            text-decoration: none;
        }

        .logo-icon {
            font-size: 1.8rem;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 32px;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            transition: var(--transition);
            position: relative;
            padding: 4px 0;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            transition: var(--transition);
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: var(--transition);
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-secondary {
            background-color: var(--white);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background-color: #F0FDF4; /* Lightest green */
            transform: translateY(-2px);
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .btn-ghost:hover {
            background-color: var(--background);
            color: var(--text-dark);
        }

        .auth-buttons {
            display: flex;
            gap: 12px;
        }
        
        /* Dashboard Header User Info */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .user-details {
            line-height: 1.3;
        }
        
        .user-name-header {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .user-plan-header {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .logout-button {
            background: transparent;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 8px;
            border-radius: 8px;
            transition: var(--transition);
        }
        
        .logout-button:hover {
            color: var(--danger);
            background-color: #FEF2F2;
        }

        /* Hero Section */
        .hero {
            padding: 80px 0;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(240, 253, 244, 0.8) 0%, rgba(239, 246, 255, 0.8) 100%);
        }

        .hero-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 60px;
        }

        .hero-text {
            flex: 1;
            animation: fadeInLeft 0.8s ease-out;
            z-index: 2;
        }
        
        .hero-text .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: var(--text-dark);
            line-height: 1.2;
            font-weight: 800;
        }

        .hero h1 span {
            color: var(--primary);
        }

        .hero p {
            font-size: 1.15rem;
            color: var(--text-light);
            max-width: 550px;
            margin-bottom: 40px;
        }
        
        .hero-actions {
            display: flex;
            gap: 16px;
        }

        .hero-image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeInRight 0.8s ease-out;
            z-index: 1;
        }
        
        .hero-stats {
            margin-top: 40px;
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .hero-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--text-light);
        }
        
        .hero-stat i {
            color: var(--accent);
        }

        /* Modern Phone Mockup */
        .phone-mockup {
            width: 320px;
            height: 640px;
            background: #1F2937; /* Dark frame */
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            padding: 14px;
            position: relative;
            animation: float 6s ease-in-out infinite;
        }
        
        .phone-mockup::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 6px;
            background: #4B5563;
            border-radius: 3px;
            z-index: 2;
        }

        .phone-screen {
            width: 100%;
            height: 100%;
            background: var(--white);
            border-radius: 26px;
            overflow: hidden;
            position: relative;
            padding: 20px;
        }
        
        .analysis-card {
            background: #F3F4F6;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .analysis-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .analysis-card-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .analysis-card-header span {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .nutrient-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .nutrient-item {
            background: var(--white);
            border-radius: 12px;
            padding: 12px;
        }
        
        .nutrient-item .label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 4px;
        }
        
        .nutrient-item .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        #hero-protein { color: var(--secondary); }
        #hero-carbs { color: var(--accent); }
        #hero-fat { color: var(--danger); }
        
        .food-item-list .item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .food-item-list .item:last-child {
            border: none;
        }
        
        .food-item-list .item-name {
            color: var(--text-dark);
            font-weight: 500;
        }
        
        .food-item-list .item-cal {
            color: var(--text-light);
            font-weight: 500;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Sections */
        .section {
            padding: 80px 0;
        }

        .section-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 16px;
            color: var(--text-dark);
        }
        
        .section-subtitle {
            text-align: center;
            font-size: 1.15rem;
            color: var(--text-light);
            max-width: 600px;
            margin: 0 auto 60px auto;
        }
        
        .section-title span {
            color: var(--primary);
        }

        /* Features Section */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .feature-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 32px;
            box-shadow: var(--card-shadow);
            text-align: left;
            transition: var(--transition);
            border: 1px solid var(--border-color);
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        
        .feature-card:nth-child(1) { animation-delay: 0.1s; }
        .feature-card:nth-child(2) { animation-delay: 0.2s; }
        .feature-card:nth-child(3) { animation-delay: 0.3s; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--hover-shadow);
        }

        .feature-icon {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .feature-card:nth-child(1) .feature-icon { background-color: var(--primary); }
        .feature-card:nth-child(2) .feature-icon { background-color: var(--secondary); }
        .feature-card:nth-child(3) .feature-icon { background-color: var(--accent); }

        .feature-card h3 {
            margin-bottom: 12px;
            color: var(--text-dark);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .feature-card p {
            color: var(--text-light);
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Pricing Section */
        #pricing {
            background-color: var(--white);
        }
        .pricing-cards {
            display: grid;
            grid-template-columns: 1fr 1.1fr 1fr;
            gap: 30px;
            align-items: center;
        }

        .pricing-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 40px;
            box-shadow: var(--card-shadow);
            text-align: left;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .pricing-card.featured {
            border: 2px solid var(--primary);
            transform: scale(1.05);
            box-shadow: var(--hover-shadow);
        }
        
        .pricing-card:not(.featured):hover {
            transform: translateY(-8px);
            box-shadow: var(--hover-shadow);
        }

        .popular-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 20px;
        }

        .plan-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-dark);
        }

        .plan-price {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .plan-price span {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-light);
        }
        
        .plan-description {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-bottom: 24px;
            min-height: 40px;
        }

        .plan-features {
            list-style: none;
            margin: 24px 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .plan-features li {
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }
        
        .plan-features li.disabled {
            color: var(--text-light);
            text-decoration: line-through;
        }

        .plan-features li i {
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .plan-features li.disabled i {
            color: var(--text-light);
        }
        
        .pricing-card .btn {
            width: 100%;
        }

        /* FAQ Section */
        .faq-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .faq-item {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .faq-item:hover {
            box-shadow: var(--hover-shadow);
        }

        .faq-question {
            padding: 24px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .faq-question i {
            transition: var(--transition);
            color: var(--primary);
        }

        .faq-answer {
            padding: 0 24px 24px;
            color: var(--text-light);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            border-top: 1px solid var(--border-color);
        }

        .faq-item.active .faq-answer {
            max-height: 200px; /* Adjust as needed */
        }

        .faq-item.active .faq-question i {
            transform: rotate(180deg);
        }

        /* Footer */
        footer {
            background-color: var(--white);
            color: var(--text-light);
            padding: 60px 0 30px;
            text-align: center;
            border-top: 1px solid var(--border-color);
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        
        .footer-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-dark);
        }

        .footer-links {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .footer-links a {
            color: var(--text-light);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        .social-icons {
            display: flex;
            gap: 24px;
        }

        .social-icons a {
            color: var(--text-light);
            font-size: 1.4rem;
            transition: var(--transition);
        }

        .social-icons a:hover {
            color: var(--primary);
            transform: translateY(-3px);
        }

        .copyright {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: 24px;
        }

        /* Authentication Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 450px;
            box-shadow: var(--hover-shadow);
            overflow: hidden;
            transform: scale(0.95);
            opacity: 0;
            transition: var(--transition);
        }
        
        .modal-overlay.show .modal-container {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            padding: 24px 32px;
            text-align: center;
            position: relative;
        }

        .modal-header h2 {
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 1.5rem;
        }
        
        .modal-header p {
            color: var(--text-light);
            font-size: 1rem;
        }
        
        .close-modal {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-modal:hover {
            color: var(--text-dark);
            background-color: var(--background);
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-form {
            padding: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
        }

        .auth-footer {
            text-align: center;
            padding: 0 32px 32px;
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* Loading Spinner */
        .loading-spinner-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner-content {
            text-align: center;
        }

        .loading-spinner-circle {
            border: 5px solid var(--primary-light);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        .loading-spinner-text {
            font-size: 1.1rem;
            color: var(--text-dark);
            font-weight: 600;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification Toast */
        .notification-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--text-dark);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: var(--hover-shadow);
            transform: translateY(150%);
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notification-toast.success {
            background-color: var(--primary);
        }
        
        .notification-toast.error {
            background-color: var(--danger);
        }

        .notification-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification-toast i {
            font-size: 1.2rem;
        }
        
        /* Dashboard Styles */
        .dashboard-page {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Dashboard Main Page */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 40px;
            border-radius: var(--border-radius);
            margin: 32px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .welcome-banner h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .welcome-banner p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .usage-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 16px 24px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .usage-card .count {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .usage-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .summary-card {
            background: var(--white);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .summary-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--white);
        }
        
        .summary-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .summary-card .label {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        .summary-card .progress-bar {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .summary-card .progress {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            width: 0;
            transition: width 0.5s ease;
        }
        
        /* Action Cards */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .action-card {
            background: var(--white);
            padding: 32px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .action-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--hover-shadow);
            border-color: var(--primary);
        }
        
        .action-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--white);
            margin: 0 auto 20px auto;
        }
        
        .action-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        
        .action-card p {
            color: var(--text-light);
            font-size: 1rem;
        }
        
        /* Recent Activity */
        .recent-activity h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .activity-item {
            background: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-details {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .activity-details .icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        .activity-info .title {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .activity-info .time {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .activity-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        /* Dashboard Sub-Pages (Analysis, Planner, Analytics) */
        .dashboard-page-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 32px 0;
        }
        
        .back-to-dash {
            background: var(--white);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .back-to-dash:hover {
            background: var(--background);
            color: var(--text-dark);
        }
        
        .dashboard-page-header h1 {
            font-size: 2rem;
            font-weight: 700;
        }
        
        /* Analysis Page */
        .upload-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .upload-area {
            width: 100%;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--white);
            margin-bottom: 24px;
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background-color: #F0FDF4;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .upload-area p {
            color: var(--text-dark);
            margin-bottom: 10px;
            font-size: 1.15rem;
            font-weight: 600;
        }

        .upload-area span {
            font-size: 0.95rem;
            color: var(--text-light);
        }

        #file-input {
            display: none;
        }

        .image-preview-container {
            width: 100%;
            max-height: 400px;
            border-radius: var(--border-radius);
            margin-top: 24px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
        }
        
        #image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .analysis-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .results-section {
            display: none;
            background-color: var(--white);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 40px;
            margin-top: 40px;
            animation: fadeIn 0.8s ease;
        }

        .results-section h2 {
            text-align: center;
            margin-bottom: 32px;
            color: var(--text-dark);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .nutrition-grid-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .nutrition-card-result {
            background: var(--background);
            border-radius: var(--border-radius);
            padding: 24px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .nutrition-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .nutrition-label {
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        #protein-value { color: var(--secondary); }
        #carbs-value { color: var(--accent); }
        #fat-value { color: var(--danger); }

        .food-items-list h3 {
            text-align: center;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .food-item-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 16px;
            padding: 0 20px 12px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .food-item-header .right { text-align: right; }

        .food-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 16px;
            align-items: center;
            padding: 16px 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            background-color: var(--white);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .food-item:hover {
            background-color: var(--background);
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        
        .food-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-dark);
        }

        .food-quantity {
            color: var(--text-light);
            font-size: 0.9rem;
            text-align: right;
        }
        
        .food-nutrient {
            text-align: right;
            font-weight: 500;
        }

        /* Meal Planner Page */
        .meal-planner-container {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 32px;
            box-shadow: var(--card-shadow);
        }
        
        .meal-planner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .meal-planner-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .meal-planner-header h2 i {
            color: var(--primary);
        }
        
        .week-navigation {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .week-nav-button {
            background: var(--white);
            border: 1px solid var(--border-color);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-light);
        }
        
        .week-nav-button:hover {
            background: var(--background);
            color: var(--text-dark);
        }
        
        .current-week {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-dark);
            min-width: 180px;
            text-align: center;
        }
        
        .meal-planner-tools {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .tool-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .tool-button {
            background-color: var(--white);
            border: 1px solid var(--border-color);
            color: var(--text-dark);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tool-button:hover {
            background-color: var(--background);
            border-color: #D1D5DB;
        }
        
        .tool-button i {
            color: var(--text-light);
        }
        
        #generate-plan {
            color: var(--primary);
            border-color: var(--primary-light);
            background: #F0FDF4;
        }
        #generate-plan:hover {
            background: var(--primary-light);
        }
        #generate-plan i { color: var(--primary); }
        
        #clear-plan {
            color: var(--danger);
            border-color: #FEE2E2;
            background: #FEF2F2;
        }
        #clear-plan:hover {
            background: #FEE2E2;
        }
        #clear-plan i { color: var(--danger); }
        
        .meal-planner-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 8px;
            overflow-x: auto; /* For small screens */
            padding-bottom: 10px;
        }
        
        .time-slot {
            font-weight: 600;
            padding: 12px 10px;
            background-color: var(--background);
            border-radius: 8px;
            text-align: center;
            color: var(--text-dark);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .day-header {
            font-weight: 600;
            text-align: center;
            padding: 12px 5px;
            background-color: var(--primary);
            color: white;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .meal-slot {
            min-height: 100px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: var(--white);
        }
        
        .meal-slot:hover {
            border-color: var(--primary);
            background-color: #F0FDF4;
        }
        
        .meal-slot.empty {
            color: var(--text-light);
        }
        
        .meal-slot.empty i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .meal-slot.filled {
            background-color: var(--white);
            border: 2px solid var(--primary);
            justify-content: flex-start;
            align-items: flex-start;
            text-align: left;
        }
        
        .meal-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .meal-calories {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .meal-macros {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 6px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        /* Nutrition Goals */
        .nutrition-goals {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-top: 24px;
        }
        
        .goals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nutrition-goals h3 {
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.25rem;
        }

        .nutrition-goals h3 i {
            color: var(--primary);
        }
        
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .goal-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .goal-label-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .goal-label {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .goal-values {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .goal-values .current {
            color: var(--text-dark);
            font-weight: 500;
        }
        
        .goal-target {
            color: var(--text-light);
        }

        .goal-progress {
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .goal-progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        #calories-progress { background: var(--primary); }
        #protein-progress { background: var(--secondary); }
        #carbs-progress { background: var(--accent); }
        #fat-progress { background: var(--danger); }
        
        /* Analytics Page */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .chart-container {
            background: var(--white);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .chart-container h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* Meal Modal (NEW) */
        #meal-modal .modal-container {
            max-width: 500px;
        }
        
        #meal-modal-content {
            padding: 0 32px 32px;
        }
        
        .search-food-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        #search-food-input {
            width: 100%;
            padding: 12px 16px;
            padding-left: 40px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .search-food-container i {
            position: absolute;
            left: 14px;
            top: 14px;
            color: var(--text-light);
        }
        
        #search-food-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--white);
        }
        
        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-result-item:last-child {
            border: none;
        }
        
        .search-result-item:hover {
            background: var(--background);
        }
        
        .search-result-item .name {
            font-weight: 500;
        }
        
        .search-result-item .details {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .custom-entry-form h4 {
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-light);
            margin: 20px 0;
            position: relative;
        }
        
        .custom-entry-form h4::before,
        .custom-entry-form h4::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border-color);
        }
        
        .custom-entry-form h4::before { left: 0; }
        .custom-entry-form h4::after { right: 0; }
        
        .macro-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        #add-meal-to-plan-button {
            width: 100%;
            margin-top: 20px;
        }

        /* Legal Pages */
        .legal-page {
            background: var(--white);
            padding: 60px 0;
        }
        
        .legal-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .legal-content h1 {
            font-size: 2.5rem;
            margin-bottom: 24px;
        }
        
        .legal-content h2 {
            font-size: 1.8rem;
            margin: 40px 0 16px;
        }
        
        .legal-content p, .legal-content li {
            color: var(--text-light);
            margin-bottom: 16px;
            line-height: 1.7;
        }
        
        .legal-content ul {
            padding-left: 20px;
        }
        
        .legal-content a {
            color: var(--primary);
            text-decoration: none;
        }
        .legal-content a:hover {
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .hero-content {
                flex-direction: column;
                text-align: center;
            }
            .hero-text {
                order: 2;
            }
            .hero-image-container {
                order: 1;
            }
            .hero p {
                margin: 0 auto 40px auto;
            }
            .hero-actions, .hero-stats {
                justify-content: center;
            }
            
            .pricing-cards {
                grid-template-columns: 1fr;
                gap: 40px;
            }
            .pricing-card.featured {
                transform: scale(1); /* Remove scale on tablet */
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .food-item-header {
                display: none;
            }
            
            .food-item {
                grid-template-columns: 2fr 1fr;
                gap: 12px;
                padding: 20px;
            }
            
            .food-name {
                grid-column: 1 / 3;
            }
            .food-quantity {
                grid-column: 1 / 3;
                text-align: left;
                margin-top: -8px;
            }
            .food-nutrient {
                text-align: left;
                padding: 8px;
                background: var(--background);
                border-radius: 8px;
            }
            .food-nutrient::before {
                content: attr(data-label);
                display: block;
                font-size: 0.8rem;
                color: var(--text-light);
                font-weight: 500;
                margin-bottom: 2px;
            }
        }
        
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 16px;
                height: auto;
                padding: 16px 0;
            }
            .nav-links {
                order: 3;
                width: 100%;
                justify-content: center;
                gap: 20px;
            }
            .auth-buttons {
                order: 2;
            }
            .logo {
                order: 1;
            }
            
            .hero h1 {
                font-size: 2.5rem;
            }
            .hero p {
                font-size: 1.05rem;
            }
            .hero-actions {
                flex-direction: column;
            }
            
            .phone-mockup {
                width: 280px;
                height: 560px;
                transform: scale(0.95);
            }
            
            .section {
                padding: 60px 0;
            }
            .section-title {
                font-size: 2rem;
            }
            .section-subtitle {
                margin-bottom: 40px;
            }
            
            .welcome-banner {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            /* Make meal planner grid scrollable */
            .meal-planner-grid {
                grid-template-columns: 60px repeat(7, 120px);
                padding-bottom: 10px;
            }
            
            .time-slot {
                font-size: 0.8rem;
            }
        }

    </style>
</head>
<body>

    <!-- Page Wrapper -->
    <div class="page-wrapper">
    
        <!-- Loading Spinner -->
        <div class="loading-spinner-overlay" id="loading-spinner">
            <div class="loading-spinner-content">
                <div class="loading-spinner-circle"></div>
                <div class="loading-spinner-text" id="loading-spinner-text">Loading...</div>
            </div>
        </div>

        <!-- Authentication Modal -->
        <div class="modal-overlay" id="auth-modal">
            <div class="modal-container">
                <div class="modal-header">
                    <span class="close-modal" id="close-auth-modal">&times;</span>
                    <h2>Welcome to EatLens</h2>
                    <p>Sign in or create an account to start</p>
                </div>
                <div class="auth-tabs">
                    <div class="auth-tab active" id="login-tab">Login</div>
                    <div class="auth-tab" id="signup-tab">Sign Up</div>
                </div>
                <div class="auth-form">
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-email">Email</label>
                            <input type="email" id="login-email" placeholder="you@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" placeholder="••••••••" required>
                        </div>
                        <button type="submit" class="btn btn-primary auth-button">Login</button>
                    </form>
                    <form id="signup-form" style="display: none;">
                        <div class="form-group">
                            <label for="signup-name">Full Name</label>
                            <input type="text" id="signup-name" placeholder="Your Name" required>
                        </div>
                        <div class="form-group">
                            <label for="signup-email">Email</label>
                            <input type="email" id="signup-email" placeholder="you@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="signup-password">Password (min. 6 characters)</label>
                            <input type="password" id="signup-password" placeholder="Create a password" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary auth-button">Create Account</button>
                    </form>
                </div>
                <div class="auth-footer">
                    <p>By continuing, you agree to our <a href="#terms-of-service" class="legal-link">Terms</a> and <a href="#privacy-policy" class="legal-link">Privacy Policy</a></p>
                </div>
            </div>
        </div>
        
        <!-- Meal Modal -->
        <div class="modal-overlay" id="meal-modal">
            <div class="modal-container">
                <div class="modal-header">
                    <span class="close-modal" id="close-meal-modal">&times;</span>
                    <h2 id="meal-modal-title">Add Meal</h2>
                    <p id="meal-modal-subtitle">Add a meal to your plan</p>
                </div>
                <div id="meal-modal-content">
                    <div class="search-food-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-food-input" placeholder="Search for food (e.g., 'Apple')">
                    </div>
                    <div id="search-food-results">
                        <!-- Search results will be populated here -->
                    </div>
                    
                    <form id="custom-entry-form" class="custom-entry-form">
                        <h4>Or Add Custom Entry</h4>
                        <div class="form-group">
                            <label for="custom-meal-name">Meal Name</label>
                            <input type="text" id="custom-meal-name" placeholder="e.g., Homemade Salad" required>
                        </div>
                        <div class="macro-inputs">
                            <div class="form-group">
                                <label for="custom-calories">Calories</label>
                                <input type="number" id="custom-calories" placeholder="kcal" required>
                            </div>
                            <div class="form-group">
                                <label for="custom-protein">Protein (g)</label>
                                <input type="number" id="custom-protein" placeholder="g">
                            </div>
                            <div class="form-group">
                                <label for="custom-carbs">Carbs (g)</label>
                                <input type="number" id="custom-carbs" placeholder="g">
                            </div>
                            <div class="form-group">
                                <label for="custom-fat">Fat (g)</label>
                                <input type="number" id="custom-fat" placeholder="g">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="add-meal-to-plan-button">Add to Plan</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div class="notification-toast" id="notification-toast">
            <i class="fas fa-check-circle"></i>
            <span id="notification-message">Action completed successfully!</span>
        </div>

        <!-- Header -->
        <header id="main-header">
            <div class="container">
                <nav class="navbar">
                    <a href="#" class="logo" id="logo-link">
                        <span class="logo-icon">🍽️</span>
                        <span>EatLens</span>
                    </a>
                    <!-- Landing Page Nav -->
                    <div class="nav-links" id="landing-nav-links">
                        <a href="#features">Features</a>
                        <a href="#pricing">Pricing</a>
                        <a href="#faq">FAQ</a>
                    </div>
                    <!-- Auth Buttons (Landing) -->
                    <div class="auth-buttons" id="landing-auth-buttons">
                        <button class="btn btn-ghost" id="login-button">Login</button>
                        <button class="btn btn-primary" id="signup-button">Get Started</button>
                    </div>
                    <!-- Dashboard Nav -->
                    <div class="user-menu" id="dashboard-nav" style="display: none;">
                        <div class="user-avatar" id="user-avatar-header">U</div>
                        <div class="user-details">
                            <div class="user-name-header" id="user-name-header">User Name</div>
                            <div class="user-plan-header" id="user-plan-header">Free Plan</div>
                        </div>
                        <button class="logout-button" id="logout-button" title="Logout">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
        
            <!-- Landing Page Content -->
            <div id="landing-page">
                <section class="hero">
                    <div class="container">
                        <div class="hero-content">
                            <div class="hero-text">
                                <div class="badge">
                                    <i class="fas fa-star"></i> AI-Powered Nutrition Analysis
                                </div>
                                <h1>Your AI Nutritionist & <span>Meal Planner</span></h1>
                                <p>Snap a photo for instant nutrition analysis, plan your weekly meals, and track your health goals with personalized AI insights.</p>
                                <div class="hero-actions">
                                    <button class="btn btn-primary btn-lg" id="hero-cta">Get Started Free <i class="fas fa-arrow-right"></i></button>
                                </div>
                                <div class="hero-stats">
                                    <div class="hero-stat">
                                        <i class="fas fa-users"></i> 50K+ Users
                                    </div>
                                    <div class="hero-stat">
                                        <i class="fas fa-star"></i> 4.9 Rating
                                    </div>
                                    <div class="hero-stat">
                                        <i class="fas fa-award"></i> Award Winning
                                    </div>
                                </div>
                            </div>
                            <div class="hero-image-container">
                                <!-- Modern Phone Mockup -->
                                <div class="phone-mockup">
                                    <div class="phone-screen">
                                        <div class="analysis-card">
                                            <div class="analysis-card-header">
                                                <h3>Nutrition Analysis</h3>
                                                <span><i class="fas fa-check"></i></span>
                                            </div>
                                            <div class="nutrient-grid">
                                                <div class="nutrient-item">
                                                    <div class="label">Calories</div>
                                                    <div class="value">420</div>
                                                </div>
                                                <div class="nutrient-item">
                                                    <div class="label">Protein</div>
                                                    <div class="value" id="hero-protein">25g</div>
                                                </div>
                                                <div class="nutrient-item">
                                                    <div class="label">Carbs</div>
                                                    <div class="value" id="hero-carbs">45g</div>
                                                </div>
                                                <div class="nutrient-item">
                                                    <div class="label">Fat</div>
                                                    <div class="value" id="hero-fat">15g</div>
                                                </div>
                                            </div>
                                            <div class="food-item-list">
                                                <div class="item">
                                                    <span class="item-name">Grilled Chicken</span>
                                                    <span class="item-cal">248 cal</span>
                                                </div>
                                                <div class="item">
                                                    <span class="item-name">Quinoa</span>
                                                    <span class="item-cal">120 cal</span>
                                                </div>
                                                <div class="item">
                                                    <span class="item-name">Broccoli</span>
                                                    <span class="item-cal">52 cal</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="features" class="section">
                    <div class="container">
                        <h2 class="section-title">All-in-One <span>Nutrition Platform</span></h2>
                        <p class="section-subtitle">Everything you need to understand your diet, plan your meals, and achieve your health goals, all in one simple platform.</p>
                        <div class="features">
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-camera"></i></div>
                                <h3>AI Nutrition Analysis</h3>
                                <p>Snap a photo of any meal and get an instant, detailed nutrition breakdown powered by advanced AI.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-calendar-alt"></i></div>
                                <h3>Smart Meal Planning</h3>
                                <p>Plan your weekly meals with our intuitive drag-and-drop calendar. Track goals and get smart suggestions.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                                <h3>Progress Analytics</h3>
                                <p>Visualize your nutrition trends with beautiful charts. Understand your habits and make data-driven decisions.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="pricing" class="section">
                    <div class="container">
                        <h2 class="section-title">Simple, Transparent <span>Pricing</span></h2>
                        <p class="section-subtitle">Choose the plan that's right for you. Start for free, and upgrade when you're ready for more power.</p>
                        <div class="pricing-cards">
                            <div class="pricing-card">
                                <div class="plan-name">Free</div>
                                <div class="plan-price">₹0<span>/month</span></div>
                                <p class="plan-description">Perfect for getting started and trying out the core features.</p>
                                <button class="btn btn-secondary" data-plan="free">Get Started</button>
                                <ul class="plan-features">
                                    <li><i class="fas fa-check"></i> 5 AI Image Analyses / month</li>
                                    <li><i class="fas fa-check"></i> Basic Nutrition Tracking</li>
                                    <li><i class="fas fa-check"></i> Basic Meal Planning</li>
                                    <li class="disabled"><i class="fas fa-times"></i> Detailed Analytics</li>
                                    <li class="disabled"><i class="fas fa-times"></i> PDF/CSV Export</li>
                                    <li class="disabled"><i class="fas fa-times"></i> AI-Generated Meal Plans</li>
                                </ul>
                            </div>
                            <div class="pricing-card featured">
                                <div class="popular-badge">MOST POPULAR</div>
                                <div class="plan-name">Pro</div>
                                <div class="plan-price">₹149<span>/month</span></div>
                                <p class="plan-description">For those serious about tracking their nutrition and health goals.</p>
                                <button class="btn btn-primary" data-plan="pro">Upgrade to Pro</button>
                                <ul class="plan-features">
                                    <li><i class="fas fa-check"></i> Unlimited AI Image Analyses</li>
                                    <li><i class="fas fa-check"></i> Advanced Nutrition Tracking</li>
                                    <li><i class="fas fa-check"></i> Advanced Meal Planning</li>
                                    <li><i class="fas fa-check"></i> Detailed Analytics</li>
                                    <li><i class="fas fa-check"></i> PDF/CSV Export</li>
                                    <li><i class="fas fa-check"></i> AI-Generated Meal Plans</li>
                                </ul>
                            </div>
                            <div class="pricing-card">
                                <div class="plan-name">Enterprise</div>
                                <div class="plan-price">Custom</div>
                                <p class="plan-description">For nutritionists, trainers, and teams who need advanced tools.</p>
                                <button class="btn btn-secondary" data-plan="enterprise">Contact Sales</button>
                                <ul class="plan-features">
                                    <li><i class="fas fa-check"></i> Everything in Pro, plus:</li>
                                    <li><i class="fas fa-check"></i> Client Management Tools</li>
                                    <li><i class="fas fa-check"></i> Custom Branding</li>
                                    <li><i class="fas fa-check"></i> Team Accounts</li>
                                    <li><i class="fas fa-check"></i> API Access</li>
                                    <li><i class="fas fa-check"></i> Priority Support</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="faq" class="section">
                    <div class="container">
                        <h2 class="section-title">Frequently Asked <span>Questions</span></h2>
                        <div class="faq-container">
                            <div class="faq-item">
                                <div class="faq-question">
                                    How accurate is the AI nutrition analysis?
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="faq-answer">
                                    <p>Our AI uses advanced visual models trained on millions of food images. For common foods and well-defined portions, it's highly accurate (85-95%). For complex, mixed dishes, it provides a very close estimate. We recommend using it as a strong guide and manually adjusting if needed.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question">
                                    Can I use the free plan forever?
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="faq-answer">
                                    <p>Absolutely! The Free plan is free forever. It gives you 5 AI analyses per month and basic planning tools, which is perfect for casual tracking. Your analysis count resets on the 1st of every month.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question">
                                    What happens when I add a meal to the planner?
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="faq-answer">
                                    <p>When you add a meal (either from an AI scan, search, or custom entry), it gets added to your selected day and meal slot. We automatically update your daily and weekly nutrition goal progress bars, so you can see exactly how you're tracking against your targets in real-time.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question">
                                    Is my data secure?
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="faq-answer">
                                    <p>Yes. Data security is our top priority. All your data is securely stored using Firebase's industry-leading infrastructure. We never share your personal data or food logs with third parties. All connections are encrypted via SSL.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Dashboard Content (Hidden by default) -->
            <div id="dashboard-content" style="display: none;">
                
                <!-- Dashboard: Main Page -->
                <div class="dashboard-page" id="dashboard-main">
                    <div class="container">
                        <div class="welcome-banner">
                            <div class="welcome-text">
                                <h1 id="welcome-user-name">Welcome back!</h1>
                                <p>Ready to continue your health journey today?</p>
                            </div>
                            <div class="usage-card">
                                <div class="count" id="dashboard-usage-count">0/5</div>
                                <div class="label">Analyses this month</div>
                            </div>
                        </div>
                        
                        <div class="summary-grid">
                            <div class="summary-card">
                                <div class="icon" style="background: var(--accent);"><i class="fas fa-fire"></i></div>
                                <div class="info">
                                    <div class="value" id="summary-calories">0</div>
                                    <div class="label">Today's Calories</div>
                                    <div class="progress-bar">
                                        <div class="progress" id="summary-calories-progress" style="width: 0%; background: var(--accent);"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card">
                                <div class="icon" style="background: var(--secondary);"><i class="fas fa-tint"></i></div>
                                <div class="info">
                                    <div class="value" id="summary-protein">0g</div>
                                    <div class="label">Today's Protein</div>
                                    <div class="progress-bar">
                                        <div class="progress" id="summary-protein-progress" style="width: 0%; background: var(--secondary);"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card">
                                <div class="icon" style="background: var(--primary);"><i class="fas fa-check-circle"></i></div>
                                <div class="info">
                                    <div class="value" id="summary-meals">0</div>
                                    <div class="label">Meals Tracked (Week)</div>
                                    <div class="progress-bar">
                                        <div class="progress" id="summary-meals-progress" style="width: 0%; background: var(--primary);"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card">
                                <div class="icon" style="background: #9333EA;"><i class="fas fa-bolt"></i></div>
                                <div class="info">
                                    <div class="value" id="summary-streak">0 days</div>
                                    <div class="label">Tracking Streak</div>
                                    <div class="progress-bar">
                                        <div class="progress" id="summary-streak-progress" style="width: 0%; background: #9333EA;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-grid">
                            <div class="action-card" id="action-analyze">
                                <div class="icon" style="background: var(--primary);"><i class="fas fa-camera"></i></div>
                                <h3>Analyze Food</h3>
                                <p>Snap a photo for instant nutrition analysis</p>
                            </div>
                            <div class="action-card" id="action-planner">
                                <div class="icon" style="background: var(--secondary);"><i class="fas fa-calendar-alt"></i></div>
                                <h3>Plan Meals</h3>
                                <p>Create and organize your weekly meal plan</p>
                            </div>
                            <div class="action-card" id="action-analytics">
                                <div class="icon" style="background: var(--accent);"><i class="fas fa-chart-pie"></i></div>
                                <h3>View Analytics</h3>
                                <p>Track your progress and nutrition trends</p>
                            </div>
                        </div>
                        
                        <div class="recent-activity">
                            <h2>Recent Activity</h2>
                            <div class="activity-list" id="recent-activity-list">
                                <!-- Activity items will be populated here -->
                                <p id="no-activity-msg" style="color: var(--text-light); text-align: center; padding: 20px 0;">No recent activity. Analyze a meal to get started!</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard: Analysis Page -->
                <div class="dashboard-page" id="analysis-page">
                    <div class="container">
                        <div class="dashboard-page-header">
                            <button class="back-to-dash" data-target="dashboard-main"><i class="fas fa-arrow-left"></i></button>
                            <h1>AI Nutrition Analysis</h1>
                        </div>
                        
                        <div class="upload-container">
                            <div class="upload-area" id="upload-area">
                                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                <p>Drag & Drop or Click to Upload</p>
                                <span>Supports JPG, PNG, WebP (Max 10MB)</span>
                                <input type="file" id="file-input" accept="image/*">
                            </div>
                            
                            <div class="analysis-actions">
                                <button class="btn btn-secondary" id="camera-button"><i class="fas fa-camera"></i> Use Camera</button>
                                <button class="btn btn-primary" id="analyze-button" disabled><i class="fas fa-magic"></i> Analyze Nutrition</button>
                            </div>
                            
                            <div class="image-preview-container" id="image-preview-container">
                                <img id="image-preview" alt="Preview of uploaded food image">
                            </div>
                        </div>
                        
                        <div class="results-section" id="results-section">
                            <h2>Your Nutrition Analysis</h2>
                            <div class="nutrition-grid-results">
                                <div class="nutrition-card-result">
                                    <div class="nutrition-value" id="calories-value">0</div>
                                    <div class="nutrition-label">Calories (kcal)</div>
                                </div>
                                <div class="nutrition-card-result">
                                    <div class="nutrition-value" id="protein-value">0g</div>
                                    <div class="nutrition-label">Protein</div>
                                </div>
                                <div class="nutrition-card-result">
                                    <div class="nutrition-value" id="carbs-value">0g</div>
                                    <div class="nutrition-label">Carbs</div>
                                </div>
                                <div class="nutrition-card-result">
                                    <div class="nutrition-value" id="fat-value">0g</div>
                                    <div class="nutrition-label">Fat</div>
                                </div>
                            </div>
                            
                            <div class="food-items-list" id="food-items-container">
                                <h3>Food Breakdown</h3>
                                <div class="food-item-header">
                                    <span>Food Item</span>
                                    <span class="right">Quantity</span>
                                    <span class="right">Calories</span>
                                    <span class="right">Protein</span>
                                    <span class="right">Fat</span>
                                </div>
                                <div id="food-items-list-content">
                                    <!-- Items added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard: Meal Planner Page -->
                <div class="dashboard-page" id="meal-planner-page">
                    <div class="container">
                        <div class="dashboard-page-header">
                            <button class="back-to-dash" data-target="dashboard-main"><i class="fas fa-arrow-left"></i></button>
                            <h1>Weekly Meal Planner</h1>
                        </div>
                        
                        <div class="meal-planner-container">
                            <div class="meal-planner-header">
                                <h2><i class="fas fa-calendar-alt"></i> Your Plan</h2>
                                <div class="week-navigation">
                                    <button class="week-nav-button" id="prev-week"><i class="fas fa-chevron-left"></i></button>
                                    <div class="current-week" id="current-week">Week of Oct 27, 2025</div>
                                    <button class="week-nav-button" id="next-week"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                            
                            <div class="meal-planner-tools">
                                <div class="tool-group">
                                    <button class="tool-button" id="generate-plan">
                                        <i class="fas fa-magic"></i> Generate Plan (AI)
                                    </button>
                                    <button class="tool-button" id="clear-plan">
                                        <i class="fas fa-trash"></i> Clear Plan
                                    </button>
                                </div>
                                <div class="tool-group">
                                    <button class="tool-button" id="download-pdf">
                                        <i class="fas fa-file-pdf"></i> Download PDF
                                    </button>
                                    <button class="tool-button" id="share-plan">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                </div>
                            </div>
                            
                            <div class="meal-planner-grid" id="meal-planner-grid">
                                <div class="time-slot"></div>
                                <div class="day-header">Mon</div>
                                <div class="day-header">Tue</div>
                                <div class="day-header">Wed</div>
                                <div class="day-header">Thu</div>
                                <div class="day-header">Fri</div>
                                <div class="day-header">Sat</div>
                                <div class="day-header">Sun</div>
                                
                                <div class="time-slot">Breakfast</div>
                                <!-- 7 breakfast slots -->
                                <div class="meal-slot empty" data-day="monday" data-meal="breakfast"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="tuesday" data-meal="breakfast"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="wednesday" data-meal="breakfast"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="thursday" data-meal="breakfast"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="friday" data-meal="breakfast"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="saturday" data-meal="breakfast"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="sunday" data-meal="breakfast"><i class="fas fa-plus"></i></div>
                                
                                <div class="time-slot">Lunch</div>
                                <!-- 7 lunch slots -->
                                <div class="meal-slot empty" data-day="monday" data-meal="lunch"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="tuesday" data-meal="lunch"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="wednesday" data-meal="lunch"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="thursday" data-meal="lunch"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="friday" data-meal="lunch"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="saturday" data-meal="lunch"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="sunday" data-meal="lunch"><i class="fas fa-plus"></i></div>
                                
                                <div class="time-slot">Dinner</div>
                                <!-- 7 dinner slots -->
                                <div class="meal-slot empty" data-day="monday" data-meal="dinner"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="tuesday" data-meal="dinner"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="wednesday" data-meal="dinner"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="thursday" data-meal="dinner"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="friday" data-meal="dinner"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="saturday" data-meal="dinner"><i class="fas fa-plus"></i></div>
                                <div class="meal-slot empty" data-day="sunday" data-meal="dinner"><i class="fas fa-plus"></i></div>
                            </div>
                            
                            <div class="nutrition-goals">
                                <div class="goals-header">
                                    <h3><i class="fas fa-bullseye"></i> Weekly Nutrition Goals</h3>
                                    <div>
                                        <button class="tool-button" id="edit-goals-button"><i class="fas fa-pencil-alt"></i> Edit Goals</button>
                                        <button class="tool-button" id="save-goals-button" style="display: none; color: var(--primary);"><i class="fas fa-save"></i> Save Goals</button>
                                    </div>
                                </div>
                                <div class="goals-grid" id="goals-grid">
                                    <!-- Goals populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard: Analytics Page -->
                <div class="dashboard-page" id="analytics-page">
                    <div class="container">
                        <div class="dashboard-page-header">
                            <button class="back-to-dash" data-target="dashboard-main"><i class="fas fa-arrow-left"></i></button>
                            <h1>Your Analytics</h1>
                        </div>
                        
                        <div class="charts-grid">
                            <div class="chart-container">
                                <h3>Weekly Calorie Intake</h3>
                                <canvas id="weekly-calories-chart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Macronutrient Breakdown</h3>
                                <canvas id="macro-doughnut-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="recent-activity">
                            <h2>Analysis History</h2>
                            <div class="activity-list" id="analytics-activity-list">
                                <!-- Full activity history populated here -->
                            </div>
                        </div>
                        
                    </div>
                </div>

            </div> <!-- End Dashboard Content -->
            
            <!-- Legal Pages (Hidden by default) -->
            <div id="legal-pages-container" style="display: none;">
                <section id="privacy-policy" class="legal-page">
                    <div class="container">
                        <div class="legal-content">
                            <button class="btn btn-secondary" id="back-to-home-privacy"><i class="fas fa-arrow-left"></i> Back to Home</button>
                            <h1 style="margin-top: 24px;">Privacy Policy</h1>
                            <p>Last updated: October 30, 2025</p>
                            
                            <h2>1. Information We Collect</h2>
                            <p>We collect information you provide directly to us when you create an account, such as your name and email address. We also store data you generate, including uploaded images for analysis, meal plans, and nutrition goals. All data is stored securely using Firebase.</p>
                            
                            <h2>2. How We Use Your Information</h2>
                            <p>Your information is used to:</p>
                            <ul>
                                <li>Provide, maintain, and improve our services.</li>
                                <li>Securely process your food images for nutrition analysis.</li>
                                <li>Personalize your meal plans and track your goals.</li>
                                <li>Communicate with you about your account.</li>
                            </ul>
                            
                            <h2>3. Data Storage and Security</h2>
                            <p>Your data (account info, meal plans, analysis history) is stored in a secure Firebase Firestore database. We use Firebase Authentication to manage your session. We implement industry-standard security measures to protect your data. We do not store your passwords, only a secure hash.</p>
                            
                            <h2>4. Data Sharing</h2>
                            <p>We do not and will not sell your personal data to third parties. Your food images are sent to Google's Gemini API for analysis and are subject to Google's privacy policies. We do not share your data with any other third parties without your explicit consent, except as required by law.</p>
                        </div>
                    </div>
                </section>

                <section id="terms-of-service" class="legal-page">
                    <div class="container">
                        <div class="legal-content">
                            <button class="btn btn-secondary" id="back-to-home-terms"><i class="fas fa-arrow-left"></i> Back to Home</button>
                            <h1 style="margin-top: 24px;">Terms of Service</h1>
                            <p>Last updated: October 30, 2025</p>
                            
                            <h2>1. Acceptance of Terms</h2>
                            <p>By creating an account and using EatLens, you agree to be bound by these Terms of Service. If you do not agree, do not use this service.</p>
                            
                            <h2>2. Description of Service</h2>
                            <p>EatLens provides AI-powered nutrition analysis and meal planning tools. The information provided is for informational purposes only and is not a substitute for professional medical advice. The AI analysis is an estimate and may not be 100% accurate. You use the service at your own risk.</p>
                            
                            <h2>3. User Accounts</h2>
                            <p>You are responsible for maintaining the confidentiality of your account. This application uses Firebase's anonymous or custom token authentication, and your session is tied to your browser. Your data is stored in a secure database associated with your unique User ID.</p>
                            
                            <h2>4. Prohibited Conduct</h2>
                            <p>You agree not to use the service to upload any content that is unlawful, harmful, or infringes on the rights of others. You also agree not to attempt to disrupt or gain unauthorized access to our service or database.</p>
                        </div>
                    </div>
                </section>
            </div>

        </main>

        <!-- Footer -->
        <footer id="main-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-logo">
                        <span class="logo-icon">🍽️</span>
                        <span>EatLens</span>
                    </div>
                    <div class="footer-links">
                        <a href="#features" class="footer-nav-link">Features</a>
                        <a href="#pricing" class="footer-nav-link">Pricing</a>
                        <a href="#faq" class="footer-nav-link">FAQ</a>
                        <a href="#privacy-policy" class="legal-link">Privacy Policy</a>
                        <a href="#terms-of-service" class="legal-link">Terms of Service</a>
                    </div>
                    <div class="social-icons">
                        <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    </div>
                    <div class="copyright">
                        &copy; 2025 EatLens. All rights reserved. Built with Firebase & Google AI.
                    </div>
                </div>
            </div>
        </footer>
    
    </div> <!-- End Page Wrapper -->


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc,
            collection,
            query,
            orderBy,
            limit,
            getDocs,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- GLOBAL STATE ---
        let db, auth;
        let currentUser = null;
        let currentFile = null;
        let currentWeekStartDate = new Date();
        let currentMealSlot = { day: null, meal: null };
        let userGoals = { calories: 2200, protein: 120, carbs: 250, fat: 70 };
        let weeklyMealPlan = {}; // { monday: { breakfast: {...}, lunch: {...} }, ... }
        let weeklyChart = null;
        let macroChart = null;

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingSpinnerText = document.getElementById('loading-spinner-text');
        
        // Pages
        const landingPage = document.getElementById('landing-page');
        const dashboardContent = document.getElementById('dashboard-content');
        const dashboardPages = document.querySelectorAll('.dashboard-page');
        const legalPagesContainer = document.getElementById('legal-pages-container');
        
        // Headers
        const mainHeader = document.getElementById('main-header');
        const mainFooter = document.getElementById('main-footer');
        const landingNav = document.getElementById('landing-nav-links');
        const landingAuth = document.getElementById('landing-auth-buttons');
        const dashboardNav = document.getElementById('dashboard-nav');
        
        // Modals
        const authModal = document.getElementById('auth-modal');
        const mealModal = document.getElementById('meal-modal');
        
        // Toast
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        
        // --- INITIALIZATION ---
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check for Firebase config variables from the environment
            if (typeof __firebase_config === 'undefined' || typeof __app_id === 'undefined') {
                console.error("Firebase config not found. App cannot initialize.");
                showNotification("Error: App configuration is missing.", "error");
                return;
            }
            
            // Parse config
            const firebaseConfig = JSON.parse(__firebase_config);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Start auth process
                initializeAuth(appId);
                
                // Setup all event listeners
                setupAuthModalListeners();
                setupMealModalListeners();
                setupLandingPageListeners();
                setupDashboardListeners();
                setupAnalysisListeners();
                setupMealPlannerListeners();
                setupAnalyticsListeners();
                setupLegalPageListeners();
                setupFAQListeners();
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showNotification("Error initializing app. Please refresh.", "error");
            }
        });
        
        // --- AUTHENTICATION ---
        
        async function initializeAuth(appId) {
            showLoadingSpinner("Authenticating...");
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    console.log("User signed in:", user.uid);
                    currentUser = { uid: user.uid, appId: appId };
                    
                    // Check if this is a new user
                    const userRef = doc(db, `artifacts/${appId}/users`, user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    let userData;
                    if (!userSnap.exists()) {
                        // New user, create their document
                        console.log("New user, creating profile...");
                        userData = {
                            uid: user.uid,
                            email: user.email || (user.isAnonymous ? `anon-${user.uid.substring(0,6)}` : 'N/A'),
                            name: user.displayName || (user.isAnonymous ? "Guest User" : "User"),
                            plan: 'free', // All users start free
                            usage: 0,
                            streak: 0,
                            lastLogin: Timestamp.now(),
                            createdAt: Timestamp.now()
                        };
                        await setDoc(userRef, userData);
                        // Save default goals
                        const goalsRef = doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'nutritionGoals');
                        await setDoc(goalsRef, userGoals);
                    } else {
                        // Existing user
                        console.log("Existing user found.");
                        userData = userSnap.data();
                        await updateDoc(userRef, { lastLogin: Timestamp.now() });
                    }
                    
                    currentUser = { ...currentUser, ...userData };
                    
                    // Load user-specific data
                    await loadUserGoals();
                    await loadWeeklyMealPlan(); // This will also update dashboard stats
                    
                    // Update UI
                    showDashboard();
                    
                } else {
                    // User is signed out, attempt to sign in
                    console.log("No user found, attempting sign-in...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            console.log("Signing in with custom token...");
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            console.log("Signing in anonymously...");
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                        showNotification("Authentication failed. Please refresh.", "error");
                        hideLoadingSpinner();
                    }
                }
            });
        }
        
        function handleLogout() {
            signOut(auth).then(() => {
                console.log("User signed out.");
                currentUser = null;
                showLandingPage();
            }).catch((error) => {
                console.error("Sign out error:", error);
            });
        }
        
        // --- UI/PAGE MANAGEMENT ---
        
        function showLoadingSpinner(text = 'Loading...') {
            loadingSpinnerText.textContent = text;
            loadingSpinner.style.display = 'flex';
        }

        function hideLoadingSpinner() {
            loadingSpinner.style.display = 'none';
        }
        
        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            notificationToast.className = 'notification-toast show'; // Reset classes
            
            if (type === 'error') {
                notificationToast.classList.add('error');
                notificationToast.querySelector('i').className = 'fas fa-exclamation-circle';
            } else {
                notificationToast.classList.add('success');
                notificationToast.querySelector('i').className = 'fas fa-check-circle';
            }

            setTimeout(() => {
                notificationToast.classList.remove('show');
            }, 3000);
        }
        
        function showDashboard() {
            // Hide landing page, show dashboard
            landingPage.style.display = 'none';
            dashboardContent.style.display = 'block';
            legalPagesContainer.style.display = 'none';
            
            // Switch headers/footers
            mainHeader.style.display = 'block';
            mainFooter.style.display = 'none';
            landingNav.style.display = 'none';
            landingAuth.style.display = 'none';
            dashboardNav.style.display = 'flex';
            
            // Update dashboard header
            document.getElementById('user-name-header').textContent = currentUser.name;
            document.getElementById('user-avatar-header').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('user-plan-header').textContent = currentUser.plan.charAt(0).toUpperCase() + currentUser.plan.slice(1) + ' Plan';
            
            // Show main dashboard page
            switchDashboardPage('dashboard-main');
            
            // Update main dashboard stats
            document.getElementById('welcome-user-name').textContent = `Welcome back, ${currentUser.name}! 👋`;
            document.getElementById('dashboard-usage-count').textContent = currentUser.plan === 'pro' ? 'Unlimited' : `${currentUser.usage || 0}/5`;
            updateDashboardSummary();
            loadRecentActivity();
            
            hideLoadingSpinner();
        }

        function showLandingPage() {
            // Show landing page, hide dashboard
            landingPage.style.display = 'block';
            dashboardContent.style.display = 'none';
            legalPagesContainer.style.display = 'none';
            
            // Switch headers/footers
            mainHeader.style.display = 'block';
            mainFooter.style.display = 'block';
            landingNav.style.display = 'flex';
            landingAuth.style.display = 'flex';
            dashboardNav.style.display = 'none';
            
            hideLoadingSpinner();
        }
        
        function switchDashboardPage(pageId) {
            dashboardPages.forEach(page => {
                page.style.display = 'none';
            });
            const newPage = document.getElementById(pageId);
            if (newPage) {
                newPage.style.display = 'block';
                window.scrollTo(0, 0);
                
                // Lazy-load charts if switching to analytics
                if(pageId === 'analytics-page') {
                    renderAnalyticsCharts();
                    loadFullActivityHistory();
                }
            }
        }
        
        function showLegalPage(pageId) {
            landingPage.style.display = 'none';
            dashboardContent.style.display = 'none';
            mainHeader.style.display = 'none';
            mainFooter.style.display = 'none';
            
            legalPagesContainer.style.display = 'block';
            document.getElementById('privacy-policy').style.display = 'none';
            document.getElementById('terms-of-service').style.display = 'none';
            
            document.getElementById(pageId).style.display = 'block';
            window.scrollTo(0, 0);
        }
        
        function hideLegalPage() {
            legalPagesContainer.style.display = 'none';
            if (currentUser) {
                showDashboard();
            } else {
                showLandingPage();
            }
        }
        
        function setupLandingPageListeners() {
            document.getElementById('login-button').addEventListener('click', () => showAuthModal('login'));
            document.getElementById('signup-button').addEventListener('click', () => showAuthModal('signup'));
            document.getElementById('hero-cta').addEventListener('click', () => showAuthModal('signup'));
            
            document.getElementById('logo-link').addEventListener('click', (e) => {
                e.preventDefault();
                if (currentUser) {
                    switchDashboardPage('dashboard-main');
                } else {
                    hideLegalPage(); // Go back to landing
                }
            });
            
            document.querySelectorAll('.pricing-card .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const plan = btn.dataset.plan;
                    if (plan === 'enterprise') {
                        alert('Please contact sales@eatlens.com for enterprise inquiries.');
                        return;
                    }
                    showAuthModal('signup');
                });
            });
        }
        
        function setupDashboardListeners() {
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            
            document.querySelectorAll('.back-to-dash').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchDashboardPage(btn.dataset.target);
                });
            });
            
            document.getElementById('action-analyze').addEventListener('click', () => switchDashboardPage('analysis-page'));
            document.getElementById('action-planner').addEventListener('click', () => switchDashboardPage('meal-planner-page'));
            document.getElementById('action-analytics').addEventListener('click', () => switchDashboardPage('analytics-page'));
        }
        
        function setupLegalPageListeners() {
            document.querySelectorAll('.legal-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.getAttribute('href').substring(1);
                    showLegalPage(pageId);
                });
            });
            
            document.getElementById('back-to-home-privacy').addEventListener('click', hideLegalPage);
            document.getElementById('back-to-home-terms').addEventListener('click', hideLegalPage);
        }
        
        function setupFAQListeners() {
            document.querySelectorAll('.faq-item').forEach(item => {
                const question = item.querySelector('.faq-question');
                question.addEventListener('click', () => {
                    // Close other open items
                    document.querySelectorAll('.faq-item.active').forEach(otherItem => {
                        if (otherItem !== item) {
                            otherItem.classList.remove('active');
                        }
                    });
                    // Toggle current item
                    item.classList.toggle('active');
                });
            });
        }
        
        // --- AUTH MODAL ---
        
        function showAuthModal(defaultTab = 'login') {
            if (defaultTab === 'login') {
                document.getElementById('login-tab').classList.add('active');
                document.getElementById('signup-tab').classList.remove('active');
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
            } else {
                document.getElementById('login-tab').classList.remove('active');
                document.getElementById('signup-tab').classList.add('active');
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('signup-form').style.display = 'block';
            }
            authModal.classList.add('show');
        }
        
        function hideAuthModal() {
            authModal.classList.remove('show');
        }
        
        function setupAuthModalListeners() {
            document.getElementById('close-auth-modal').addEventListener('click', hideAuthModal);
            
            document.getElementById('login-tab').addEventListener('click', () => {
                document.getElementById('login-tab').classList.add('active');
                document.getElementById('signup-tab').classList.remove('active');
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
            });
            
            document.getElementById('signup-tab').addEventListener('click', () => {
                document.getElementById('login-tab').classList.remove('active');
                document.getElementById('signup-tab').classList.add('active');
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('signup-form').style.display = 'block';
            });
            
            // Note: Firebase Auth with Email/Password requires it to be enabled in the Firebase console.
            // Since we're using anonymous/custom token, these forms are for show/placeholder.
            // I will simulate the signup/login locally to "upgrade" the anonymous account info.
            
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                showNotification("Login functionality is for demo purposes. Your session is already active.", "success");
                hideAuthModal();
            });
            
            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('signup-name').value;
                if (!name || !currentUser) {
                    showNotification("Please enter a name.", "error");
                    return;
                }
                
                showLoadingSpinner("Updating profile...");
                
                // Update the user's profile in Firebase
                try {
                    const userRef = doc(db, `artifacts/${currentUser.appId}/users`, currentUser.uid);
                    await updateDoc(userRef, { name: name });
                    currentUser.name = name; // Update local state
                    
                    showNotification("Profile updated successfully!", "success");
                    hideAuthModal();
                    showDashboard(); // Refresh dashboard with new name
                } catch (error) {
                    console.error("Profile update error:", error);
                    showNotification("Could not update profile.", "error");
                    hideLoadingSpinner();
                }
            });
        }
        
        // --- DASHBOARD MAIN PAGE ---
        
        function updateDashboardSummary() {
            // 1. Calculate Today's Totals from weeklyMealPlan
            const today = new Date().toLocaleString('en-us', { weekday: 'long' }).toLowerCase();
            const todayMeals = weeklyMealPlan[today] || {};
            
            let todayCalories = 0;
            let todayProtein = 0;
            
            Object.values(todayMeals).forEach(meal => {
                todayCalories += parseFloat(meal.calories || 0);
                todayProtein += parseFloat(meal.protein || 0);
            });

            // 2. Calculate Weekly Meals Tracked
            let weeklyMealsCount = 0;
            Object.values(weeklyMealPlan).forEach(day => {
                weeklyMealsCount += Object.keys(day).length;
            });
            
            // 3. Get Streak (mocked for this demo, would require daily login logic)
            const streak = currentUser.streak || 0;
            
            // 4. Animate Counters
            animateCountUp('summary-calories', todayCalories, 0);
            animateCountUp('summary-protein', todayProtein, 0, 'g');
            animateCountUp('summary-meals', weeklyMealsCount, 0);
            animateCountUp('summary-streak', streak, 0, ' days');
            
            // 5. Update Progress Bars
            const calPercent = Math.min(100, (todayCalories / userGoals.calories) * 100);
            const proPercent = Math.min(100, (todayProtein / userGoals.protein) * 100);
            const mealPercent = Math.min(100, (weeklyMealsCount / 21) * 100); // 21 meals in a week
            const streakPercent = Math.min(100, (streak / 30) * 100); // Goal of 30 days
            
            document.getElementById('summary-calories-progress').style.width = `${calPercent}%`;
            document.getElementById('summary-protein-progress').style.width = `${proPercent}%`;
            document.getElementById('summary-meals-progress').style.width = `${mealPercent}%`;
            document.getElementById('summary-streak-progress').style.width = `${streakPercent}%`;
        }
        
        function animateCountUp(elementId, endValue, decimals = 0, suffix = '') {
            const el = document.getElementById(elementId);
            if (!el) return;
            const duration = 1500;
            const frameRate = 1000 / 60;
            const totalFrames = Math.round(duration / frameRate);
            let frame = 0;
            const startValue = parseFloat(el.textContent.replace(/[^0-9.]/g, '')) || 0;
            const increment = (endValue - startValue) / totalFrames;
            
            const counter = setInterval(() => {
                frame++;
                let currentValue = startValue + (increment * frame);
                
                if (frame === totalFrames) {
                    currentValue = endValue;
                    clearInterval(counter);
                }
                
                el.textContent = currentValue.toFixed(decimals) + suffix;
            }, frameRate);
        }
        
        async function loadRecentActivity() {
            const listEl = document.getElementById('recent-activity-list');
            const noActivityEl = document.getElementById('no-activity-msg');
            listEl.innerHTML = ''; // Clear list
            
            try {
                const analysesRef = collection(db, `artifacts/${currentUser.appId}/users/${currentUser.uid}/analyses`);
                const q = query(analysesRef, orderBy("timestamp", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    listEl.appendChild(noActivityEl);
                    noActivityEl.style.display = 'block';
                    return;
                }
                
                noActivityEl.style.display = 'none';
                querySnapshot.forEach(docSnap => {
                    const analysis = docSnap.data();
                    const itemEl = document.createElement('div');
                    itemEl.className = 'activity-item';
                    
                    const date = analysis.timestamp.toDate();
                    const timeAgo = formatTimeAgo(date);
                    const title = analysis.food[0]?.name || 'Analyzed Meal';
                    const titleShort = title.length > 25 ? title.substring(0, 25) + '...' : title;
                    
                    itemEl.innerHTML = `
                        <div class="activity-details">
                            <div class="icon"><i class="fas fa-camera"></i></div>
                            <div class="activity-info">
                                <div class="title">${titleShort} ${analysis.food.length > 1 ? `& ${analysis.food.length - 1} more` : ''}</div>
                                <div class="time">${timeAgo}</div>
                            </div>
                        </div>
                        <div class="activity-value">${analysis.total.calories} cal</div>
                    `;
                    listEl.appendChild(itemEl);
                });
                
            } catch (error) {
                console.error("Error loading recent activity:", error);
                listEl.appendChild(noActivityEl);
                noActivityEl.style.display = 'block';
                noActivityEl.textContent = 'Could not load activity.';
            }
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }
        
        // --- ANALYSIS PAGE ---
        
        function setupAnalysisListeners() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const analyzeButton = document.getElementById('analyze-button');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
            });
            
            uploadArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                handleFile(file);
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFile(e.target.files[0]);
            });
            
            document.getElementById('camera-button').addEventListener('click', () => {
                showNotification("Camera access is not implemented in this demo.", "error");
            });
            
            analyzeButton.addEventListener('click', () => {
                if (!currentFile) {
                    showNotification("Please upload an image first.", "error");
                    return;
                }
                
                // Check usage
                if (currentUser.plan === 'free' && (currentUser.usage || 0) >= 5) {
                    showNotification("You've reached your free limit of 5 analyses/month. Please upgrade to Pro!", "error");
                    return;
                }
                
                analyzeImageWithGemini(currentFile);
            });
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                showNotification("Invalid file type. Please upload an image.", "error");
                return;
            }
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showNotification("File is too large. Max 10MB.", "error");
                return;
            }
            
            currentFile = file;
            const preview = document.getElementById('image-preview');
            const previewContainer = document.getElementById('image-preview-container');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                previewContainer.style.display = 'block';
                document.getElementById('analyze-button').disabled = false;
                document.getElementById('results-section').style.display = 'none'; // Hide old results
            }
            reader.readAsDataURL(file);
        }
        
        async function analyzeImageWithGemini(file) {
            showLoadingSpinner("AI is analyzing your meal...");
            document.getElementById('analyze-button').disabled = true;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result.split(',')[1];
                const apiKey = ""; // API key is injected by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const prompt = `Analyze this food image and provide a detailed nutritional breakdown. Identify all food items visible and estimate their quantities. For each food item, provide: name, estimated quantity in grams, calories (number), protein (number, in grams), carbs (number, in grams), and fat (number, in grams). 
                Also provide a total summary of calories, protein, carbs, and fat for the entire meal.
                Format your response as a valid JSON object with the following structure: 
                {"status": "success", "food": [ {"name": "...", "quantity": "...", "calories": 0, "protein": 0, "carbs": 0, "fat": 0} ], "total": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0 } }
                If the image is not food, respond with: {"status": "error", "message": "This does not appear to be food."}`;

                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                        throw new Error("Invalid API response structure.");
                    }
                    
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const nutritionData = JSON.parse(jsonText);
                    
                    if (nutritionData.status === 'error') {
                        showNotification(nutritionData.message || "Could not analyze image.", "error");
                        hideLoadingSpinner();
                        document.getElementById('analyze-button').disabled = false;
                        return;
                    }
                    
                    // Success! Display results
                    displayAnalysisResults(nutritionData);
                    
                    // Update user usage
                    const newUsage = (currentUser.usage || 0) + 1;
                    const userRef = doc(db, `artifacts/${currentUser.appId}/users`, currentUser.uid);
                    await updateDoc(userRef, { usage: newUsage });
                    currentUser.usage = newUsage; // Update local state
                    
                    // Save analysis to history
                    const analysesRef = collection(db, `artifacts/${currentUser.appId}/users/${currentUser.uid}/analyses`);
                    await addDoc(analysesRef, {
                        ...nutritionData,
                        timestamp: Timestamp.now()
                    });
                    
                    showNotification("Analysis complete!", "success");
                    
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    // Handle demo data on API failure
                    showNotification("AI analysis failed. Using demo data.", "error");
                    displayAnalysisResults(getDemoNutritionData());
                } finally {
                    hideLoadingSpinner();
                    document.getElementById('analyze-button').disabled = false;
                    document.getElementById('dashboard-usage-count').textContent = currentUser.plan === 'pro' ? 'Unlimited' : `${currentUser.usage || 0}/5`;
                }
            };
            reader.readAsDataURL(file);
        }
        
        function displayAnalysisResults(data) {
            document.getElementById('calories-value').textContent = data.total.calories.toFixed(0);
            document.getElementById('protein-value').textContent = data.total.protein.toFixed(1) + 'g';
            document.getElementById('carbs-value').textContent = data.total.carbs.toFixed(1) + 'g';
            document.getElementById('fat-value').textContent = data.total.fat.toFixed(1) + 'g';
            
            const listContent = document.getElementById('food-items-list-content');
            listContent.innerHTML = ''; // Clear previous
            
            if (data.food.length === 0) {
                listContent.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px 0;">No individual food items were identified.</p>';
            } else {
                data.food.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'food-item';
                    itemEl.innerHTML = `
                        <div class="food-name">${item.name}</div>
                        <div class="food-quantity">${item.quantity}</div>
                        <div class="food-nutrient" data-label="Calories">${item.calories.toFixed(0)}</div>
                        <div class="food-nutrient" data-label="Protein">${item.protein.toFixed(1)}g</div>
                        <div class="food-nutrient" data-label="Fat">${item.fat.toFixed(1)}g</div>
                    `;
                    // Note: Carbs is missing in the 5-column layout. Let's fix the layout.
                    // The old layout was 5-col. I'll make it 6.
                    // Oh, wait, the old layout was 5 col (Name, Qty, Cal, Pro, Fat). Carbs was missing.
                    // My new layout is (Name, Qty, Cal, Pro, Fat). I will add Carbs.
                    
                    // Let's redefine the grid and items
                    // Header
                    document.querySelector('.food-item-header').innerHTML = `
                        <span>Food Item</span>
                        <span class="right">Quantity</span>
                        <span class="right">Calories</span>
                        <span class="right">Protein</span>
                        <span class="right">Carbs</span>
                        <span class="right">Fat</span>
                    `;
                    document.querySelector('.food-item-header').style.gridTemplateColumns = "2fr 1fr 1fr 1fr 1fr 1fr";
                    
                    // Item
                    itemEl.style.gridTemplateColumns = "2fr 1fr 1fr 1fr 1fr 1fr";
                    itemEl.innerHTML = `
                        <div class="food-name">${item.name}</div>
                        <div class="food-quantity">${item.quantity}</div>
                        <div class="food-nutrient" data-label="Calories">${item.calories.toFixed(0)}</div>
                        <div class="food-nutrient" data-label="Protein">${item.protein.toFixed(1)}g</div>
                        <div class="food-nutrient" data-label="Carbs">${item.carbs.toFixed(1)}g</div>
                        <div class="food-nutrient" data-label="Fat">${item.fat.toFixed(1)}g</div>
                    `;
                    
                    listContent.appendChild(itemEl);
                });
            }
            
            document.getElementById('results-section').style.display = 'block';
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        function getDemoNutritionData() {
            return {
                "status": "success",
                "food": [
                    {"name": "Demo Chicken Breast", "quantity": "150g", "calories": 248, "protein": 46, "carbs": 0, "fat": 5.3},
                    {"name": "Demo Broccoli", "quantity": "100g", "calories": 34, "protein": 2.8, "carbs": 7, "fat": 0.4},
                    {"name": "Demo Quinoa", "quantity": "100g", "calories": 120, "protein": 4.1, "carbs": 21, "fat": 1.9}
                ],
                "total": { "calories": 402, "protein": 52.9, "carbs": 28, "fat": 7.6 }
            };
        }
        
        // --- MEAL PLANNER ---
        
        async function loadUserGoals() {
            try {
                const goalsRef = doc(db, `artifacts/${currentUser.appId}/users/${currentUser.uid}/data`, 'nutritionGoals');
                const docSnap = await getDoc(goalsRef);
                if (docSnap.exists()) {
                    userGoals = docSnap.data();
                } else {
                    // Save default goals if none exist
                    await setDoc(goalsRef, userGoals);
                }
                updateGoalsUI(false); // Update UI, not in edit mode
            } catch (error) {
                console.error("Error loading user goals:", error);
            }
        }
        
        async function saveUserGoals() {
            // Read values from contenteditable spans
            userGoals.calories = parseInt(document.getElementById('goal-val-calories').textContent) || 2200;
            userGoals.protein = parseInt(document.getElementById('goal-val-protein').textContent) || 120;
            userGoals.carbs = parseInt(document.getElementById('goal-val-carbs').textContent) || 250;
            userGoals.fat = parseInt(document.getElementById('goal-val-fat').textContent) || 70;
            
            try {
                showLoadingSpinner("Saving goals...");
                const goalsRef = doc(db, `artifacts/${currentUser.appId}/users/${currentUser.uid}/data`, 'nutritionGoals');
                await setDoc(goalsRef, userGoals);
                updateGoalsUI(false); // Toggle back to view mode
                updateWeeklyGoalProgress(); // Recalculate progress
                showNotification("Goals saved!", "success");
            } catch (error) {
                console.error("Error saving goals:", error);
                showNotification("Could not save goals.", "error");
            } finally {
                hideLoadingSpinner();
            }
        }
        
        function updateGoalsUI(isEditing) {
            const goalsGrid = document.getElementById('goals-grid');
            goalsGrid.innerHTML = ''; // Clear
            
            const goals = [
                { id: 'calories', label: 'Calories', unit: 'kcal', value: userGoals.calories, color: 'var(--primary)' },
                { id: 'protein', label: 'Protein', unit: 'g', value: userGoals.protein, color: 'var(--secondary)' },
                { id: 'carbs', label: 'Carbs', unit: 'g', value: userGoals.carbs, color: 'var(--accent)' },
                { id: 'fat', label: 'Fat', unit: 'g', value: userGoals.fat, color: 'var(--danger)' },
            ];
            
            goals.forEach(goal => {
                const goalEl = document.createElement('div');
                goalEl.className = 'goal-item';
                goalEl.innerHTML = `
                    <div class="goal-label-container">
                        <span class="goal-label">${goal.label}</span>
                        <div class="goal-values">
                            <span class="current" id="goal-prog-${goal.id}">0</span> / 
                            <span class="goal-target" id="goal-val-${goal.id}" contenteditable="${isEditing}">${goal.value}</span>
                            ${goal.unit}
                        </div>
                    </div>
                    <div class="goal-progress">
                        <div class="goal-progress-bar" id="goal-bar-${goal.id}" style="width: 0%; background-color: ${goal.color};"></div>
                    </div>
                `;
                goalsGrid.appendChild(goalEl);
            });
            
            // Toggle button visibility
            document.getElementById('edit-goals-button').style.display = isEditing ? 'none' : 'inline-flex';
            document.getElementById('save-goals-button').style.display = isEditing ? 'inline-flex' : 'none';
        }
        
        function toggleGoalEdit(isEditing) {
            updateGoalsUI(isEditing);
            if(isEditing) {
                // Focus the first editable element
                document.getElementById('goal-val-calories').focus();
            }
            updateWeeklyGoalProgress(); // Update progress numbers
        }
        
        function setupMealPlannerListeners() {
            // Week Navigation
            document.getElementById('prev-week').addEventListener('click', () => changeWeek(-7));
            document.getElementById('next-week').addEventListener('click', () => changeWeek(7));
            
            // Tool Buttons
            document.getElementById('generate-plan').addEventListener('click', generateAIPlan);
            document.getElementById('clear-plan').addEventListener('click', clearWeekPlan);
            document.getElementById('download-pdf').addEventListener('click', downloadPlanAsPDF);
            document.getElementById('share-plan').addEventListener('click', sharePlan);
            
            // Goal Edit Buttons
            document.getElementById('edit-goals-button').addEventListener('click', () => toggleGoalEdit(true));
            document.getElementById('save-goals-button').addEventListener('click', saveUserGoals);
            
            // Meal Slots
            document.getElementById('meal-planner-grid').addEventListener('click', (e) => {
                const slot = e.target.closest('.meal-slot');
                if (!slot) return;
                
                currentMealSlot.day = slot.dataset.day;
                currentMealSlot.meal = slot.dataset.meal;
                
                showMealModal();
            });
            
            // Set initial date
            setWeek(new Date());
        }
        
        function setWeek(date) {
            // Set to Monday of the given date's week
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
            currentWeekStartDate = new Date(date.setDate(diff));
            
            updateWeekDisplay();
            loadWeeklyMealPlan();
        }
        
        function changeWeek(dayOffset) {
            currentWeekStartDate.setDate(currentWeekStartDate.getDate() + dayOffset);
            setWeek(currentWeekStartDate);
        }
        
        function updateWeekDisplay() {
            const options = { month: 'short', day: 'numeric' };
            document.getElementById('current-week').textContent = `Week of ${currentWeekStartDate.toLocaleDateString('en-US', options)}`;
            
            // Update day headers
            const headers = document.querySelectorAll('.day-header');
            const tempDate = new Date(currentWeekStartDate);
            headers.forEach(header => {
                header.textContent = tempDate.toLocaleDateString('en-US', { weekday: 'short' });
                tempDate.setDate(tempDate.getDate() + 1);
            });
        }
        
        async function loadWeeklyMealPlan() {
            showLoadingSpinner("Loading meal plan...");
            const weekId = getWeekId(currentWeekStartDate);
            
            try {
                const planRef = doc(db, `artifacts/${currentUser.appId}/users/${currentUser.uid}/mealPlans`, weekId);
                const docSnap = await getDoc(planRef);
                
                if (docSnap.exists()) {
                    weeklyMealPlan = docSnap.data().plan || {};
                } else {
                    weeklyMealPlan = {}; // No plan found for this week
                }
                
                renderMealPlan();
                updateWeeklyGoalProgress();
                updateDashboardSummary(); // Update main dashboard too
                
            } catch (error) {
                console.error("Error loading meal plan:", error);
                showNotification("Could not load meal plan.", "error");
            } finally {
                hideLoadingSpinner();
            }
        }
        
        async function saveWeeklyMealPlan() {
            const weekId = getWeekId(currentWeekStartDate);
            try {
                const planRef = doc(db, `artifacts/${currentUser.appId}/users/${currentUser.uid}/mealPlans`, weekId);
                await setDoc(planRef, {
                    plan: weeklyMealPlan,
                    updatedAt: Timestamp.now()
                });
                console.log("Meal plan saved:", weekId);
            } catch (error) {
                console.error("Error saving meal plan:", error);
                showNotification("Could not save plan changes.", "error");
            }
        }
        
        function getWeekId(date) {
            // Creates a YYYY-MM-DD string for the Monday of that week
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        function renderMealPlan() {
            document.querySelectorAll('.meal-slot').forEach(slot => {
                const day = slot.dataset.day;
                const meal = slot.dataset.meal;
                const mealData = weeklyMealPlan[day] ? weeklyMealPlan[day][meal] : null;
                
                if (mealData) {
                    slot.classList.remove('empty');
                    slot.classList.add('filled');
                    slot.innerHTML = `
                        <div class="meal-name">${mealData.name}</div>
                        <div class="meal-calories">${mealData.calories} cal</div>
                        <div class="meal-macros">
                            <span>P: ${mealData.protein || 0}g</span>
                            <span>C: ${mealData.carbs || 0}g</span>
                            <span>F: ${mealData.fat || 0}g</span>
                        </div>
                    `;
                } else {
                    slot.classList.add('empty');
                    slot.classList.remove('filled');
                    slot.innerHTML = `<i class="fas fa-plus"></i>`;
                }
            });
        }
        
        function updateWeeklyGoalProgress() {
            let total = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            
            Object.values(weeklyMealPlan).forEach(day => {
                Object.values(day).forEach(meal => {
                    total.calories += parseFloat(meal.calories || 0);
                    total.protein += parseFloat(meal.protein || 0);
                    total.carbs += parseFloat(meal.carbs || 0);
                    total.fat += parseFloat(meal.fat || 0);
                });
            });
            
            const weeklyGoals = {
                calories: userGoals.calories * 7,
                protein: userGoals.protein * 7,
                carbs: userGoals.carbs * 7,
                fat: userGoals.fat * 7
            };
            
            // Update progress bars
            const calPercent = Math.min(100, (total.calories / weeklyGoals.calories) * 100);
            const proPercent = Math.min(100, (total.protein / weeklyGoals.protein) * 100);
            const carbPercent = Math.min(100, (total.carbs / weeklyGoals.carbs) * 100);
            const fatPercent = Math.min(100, (total.fat / weeklyGoals.fat) * 100);
            
            document.getElementById('goal-bar-calories').style.width = `${calPercent}%`;
            document.getElementById('goal-bar-protein').style.width = `${proPercent}%`;
            document.getElementById('goal-bar-carbs').style.width = `${carbPercent}%`;
            document.getElementById('goal-bar-fat').style.width = `${fatPercent}%`;
            
            // Update progress text
            document.getElementById('goal-prog-calories').textContent = total.calories.toFixed(0);
            document.getElementById('goal-prog-protein').textContent = total.protein.toFixed(0);
            document.getElementById('goal-prog-carbs').textContent = total.carbs.toFixed(0);
            document.getElementById('goal-prog-fat').textContent = total.fat.toFixed(0);
            
            // Update target text (in case it was changed)
            document.getElementById('goal-val-calories').textContent = userGoals.calories;
            document.getElementById('goal-val-protein').textContent = userGoals.protein;
            document.getElementById('goal-val-carbs').textContent = userGoals.carbs;
            document.getElementById('goal-val-fat').textContent = userGoals.fat;
        }
        
        async function generateAIPlan() {
            if (currentUser.plan === 'free') {
                showNotification("AI Plan Generation is a Pro feature. Please upgrade!", "error");
                return;
            }
            
            showLoadingSpinner("AI is generating your plan...");
            
            const apiKey = ""; // Injected by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
            const prompt = `Create a 7-day meal plan (Monday to Sunday) for breakfast, lunch, and dinner. The user's goals per DAY are: ${userGoals.calories} kcal, ${userGoals.protein}g protein, ${userGoals.carbs}g carbs, and ${userGoals.fat}g fat.
            Provide 3 simple meal ideas for each slot.
            Respond ONLY with a valid JSON object in this exact structure:
            {
              "monday": {
                "breakfast": {"name": "...", "calories": 0, "protein": 0, "carbs": 0, "fat": 0},
                "lunch": {"name": "...", "calories": 0, "protein": 0, "carbs": 0, "fat": 0},
                "dinner": {"name": "...", "calories": 0, "protein": 0, "carbs": 0, "fat": 0}
              },
              "tuesday": { ... },
              ...
              "sunday": { ... }
            }
            Ensure all values are numbers. Be creative and balanced.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error("API request failed");
                
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                const aiPlan = JSON.parse(jsonText);
                
                weeklyMealPlan = aiPlan;
                renderMealPlan();
                updateWeeklyGoalProgress();
                await saveWeeklyMealPlan();
                
                showNotification("AI meal plan generated and saved!", "success");
                
            } catch (error) {
                console.error("AI Plan Generation Error:", error);
                showNotification("AI plan generation failed. Please try again.", "error");
            } finally {
                hideLoadingSpinner();
            }
        }
        
        async function clearWeekPlan() {
            if (confirm("Are you sure you want to clear the entire week's plan?")) {
                weeklyMealPlan = {};
                renderMealPlan();
                updateWeeklyGoalProgress();
                await saveWeeklyMealPlan();
                showNotification("Plan cleared.", "success");
            }
        }
        
        function downloadPlanAsPDF() {
            showLoadingSpinner("Generating PDF...");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const planner = document.getElementById('meal-planner-grid');
            
            html2canvas(planner, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth() - 20;
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                doc.setFontSize(20);
                doc.text("Weekly Meal Plan", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.text(document.getElementById('current-week').textContent, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });
                
                doc.addImage(imgData, 'PNG', 10, 40, pdfWidth, pdfHeight);
                
                doc.save(`EatLens_Meal_Plan_${getWeekId(currentWeekStartDate)}.pdf`);
                hideLoadingSpinner();
            }).catch(err => {
                console.error("Error generating PDF:", err);
                showNotification("Could not generate PDF.", "error");
                hideLoadingSpinner();
            });
        }
        
        function sharePlan() {
            let shareText = `My EatLens Meal Plan for ${document.getElementById('current-week').textContent}:\n\n`;
            
            for (const day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']) {
                shareText += `${day.charAt(0).toUpperCase() + day.slice(1)}:\n`;
                const dayPlan = weeklyMealPlan[day];
                if (dayPlan) {
                    shareText += `  B: ${dayPlan.breakfast ? dayPlan.breakfast.name : '...'}\n`;
                    shareText += `  L: ${dayPlan.lunch ? dayPlan.lunch.name : '...'}\n`;
                    shareText += `  D: ${dayPlan.dinner ? dayPlan.dinner.name : '...'}\n`;
                } else {
                    shareText += `  (No meals planned)\n`;
                }
            }
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification("Plan copied to clipboard!", "success");
                }).catch(() => {
                    showNotification("Could not copy plan.", "error");
                });
            }
        }
        
        // --- MEAL MODAL ---
        
        function showMealModal() {
            // Reset form
            document.getElementById('custom-entry-form').reset();
            document.getElementById('search-food-input').value = '';
            document.getElementById('search-food-results').innerHTML = '';
            
            // Set title
            const day = currentMealSlot.day.charAt(0).toUpperCase() + currentMealSlot.day.slice(1);
            const meal = currentMealSlot.meal.charAt(0).toUpperCase() + currentMealSlot.meal.slice(1);
            document.getElementById('meal-modal-title').textContent = `Add to ${meal}`;
            document.getElementById('meal-modal-subtitle').textContent = `For ${day}, ${document.getElementById('current-week').textContent}`;
            
            // Check for existing data
            const existingData = weeklyMealPlan[currentMealSlot.day] ? weeklyMealPlan[currentMealSlot.day][currentMealSlot.meal] : null;
            if (existingData) {
                document.getElementById('custom-meal-name').value = existingData.name;
                document.getElementById('custom-calories').value = existingData.calories;
                document.getElementById('custom-protein').value = existingData.protein || '';
                document.getElementById('custom-carbs').value = existingData.carbs || '';
                document.getElementById('custom-fat').value = existingData.fat || '';
                document.getElementById('add-meal-to-plan-button').textContent = "Update Meal";
            } else {
                document.getElementById('add-meal-to-plan-button').textContent = "Add to Plan";
            }
            
            mealModal.classList.add('show');
        }
        
        function hideMealModal() {
            mealModal.classList.remove('show');
        }
        
        function setupMealModalListeners() {
            document.getElementById('close-meal-modal').addEventListener('click', hideMealModal);
            
            // Custom Entry Form
            document.getElementById('custom-entry-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const mealData = {
                    name: document.getElementById('custom-meal-name').value,
                    calories: parseFloat(document.getElementById('custom-calories').value),
                    protein: parseFloat(document.getElementById('custom-protein').value) || 0,
                    carbs: parseFloat(document.getElementById('custom-carbs').value) || 0,
                    fat: parseFloat(document.getElementById('custom-fat').value) || 0,
                };
                
                addMealToPlan(mealData);
            });
            
            // Search (simulated)
            document.getElementById('search-food-input').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const resultsEl = document.getElementById('search-food-results');
                resultsEl.innerHTML = '';
                
                if (query.length < 2) return;
                
                // Demo search results
                const demoResults = [
                    { name: "Apple", details: "1 medium (182g)", calories: 95, protein: 0.5, carbs: 25, fat: 0.3 },
                    { name: "Chicken Breast", details: "100g cooked", calories: 165, protein: 31, carbs: 0, fat: 3.6 },
                    { name: "Oats", details: "1/2 cup (40g) dry", calories: 150, protein: 5, carbs: 27, fat: 2.5 },
                    { name: "Scrambled Eggs", details: "2 large eggs", calories: 180, protein: 12, carbs: 1, fat: 14 }
                ];
                
                demoResults.filter(item => item.name.toLowerCase().includes(query)).forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'search-result-item';
                    itemEl.innerHTML = `
                        <div class="name">${item.name}</div>
                        <div class="details">${item.details} - ${item.calories} cal</div>
                    `;
                    itemEl.onclick = () => {
                        addMealToPlan(item);
                    };
                    resultsEl.appendChild(itemEl);
                });
            });
        }
        
        function addMealToPlan(mealData) {
            const { day, meal } = currentMealSlot;
            
            if (!weeklyMealPlan[day]) {
                weeklyMealPlan[day] = {};
            }
            
            weeklyMealPlan[day][meal] = mealData;
            
            renderMealPlan();
            updateWeeklyGoalProgress();
            updateDashboardSummary();
            saveWeeklyMealPlan(); // Async save
            
            hideMealModal();
            showNotification(`${mealData.name} added to plan!`, "success");
        }
        
        // --- ANALYTICS PAGE ---
        
        function setupAnalyticsListeners() {
            // Charts are rendered on page switch
        }
        
        function renderAnalyticsCharts() {
            // 1. Weekly Calorie Chart
            const weeklyCtx = document.getElementById('weekly-calories-chart').getContext('2d');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            const dailyCalories = dayKeys.map(day => {
                const dayPlan = weeklyMealPlan[day] || {};
                return Object.values(dayPlan).reduce((acc, meal) => acc + parseFloat(meal.calories || 0), 0);
            });
            
            if (weeklyChart) weeklyChart.destroy();
            weeklyChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Calories',
                        data: dailyCalories,
                        borderColor: var(--primary),
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Daily Goal',
                        data: Array(7).fill(userGoals.calories),
                        borderColor: var(--accent),
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // 2. Macro Doughnut Chart
            const macroCtx = document.getElementById('macro-doughnut-chart').getContext('2d');
            let total = { protein: 0, carbs: 0, fat: 0 };
            
            Object.values(weeklyMealPlan).forEach(day => {
                Object.values(day).forEach(meal => {
                    total.protein += parseFloat(meal.protein || 0);
                    total.carbs += parseFloat(meal.carbs || 0);
                    total.fat += parseFloat(meal.fat || 0);
                });
            });
            
            // If all are 0, show placeholder
            const totalMacros = total.protein + total.carbs + total.fat;
            if (totalMacros === 0) {
                total = { protein: 1, carbs: 1, fat: 1 }; // Show equal parts
            }
            
            if (macroChart) macroChart.destroy();
            macroChart = new Chart(macroCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Protein (g)', 'Carbs (g)', 'Fat (g)'],
                    datasets: [{
                        data: [total.protein, total.carbs, total.fat],
                        backgroundColor: [
                            'rgb(59, 130, 246)', // secondary
                            'rgb(245, 158, 11)', // accent
                            'rgb(239, 68, 68)' // danger
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        async function loadFullActivityHistory() {
            const listEl = document.getElementById('analytics-activity-list');
            listEl.innerHTML = ''; // Clear list
            showLoadingSpinner("Loading history...");
            
            try {
                const analysesRef = collection(db, `artifacts/${currentUser.appId}/users/${currentUser.uid}/analyses`);
                const q = query(analysesRef, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px 0;">No analysis history found.</p>';
                    return;
                }
                
                querySnapshot.forEach(docSnap => {
                    const analysis = docSnap.data();
                    const itemEl = document.createElement('div');
                    itemEl.className = 'activity-item';
                    
                    const date = analysis.timestamp.toDate();
                    const title = analysis.food[0]?.name || 'Analyzed Meal';
                    
                    itemEl.innerHTML = `
                        <div class="activity-details">
                            <div class="icon"><i class="fas fa-camera"></i></div>
                            <div class="activity-info">
                                <div class="title">${title} ${analysis.food.length > 1 ? `& ${analysis.food.length - 1} more` : ''}</div>
                                <div class="time">${date.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="activity-value">${analysis.total.calories} cal</div>
                    `;
                    listEl.appendChild(itemEl);
                });
                
            } catch (error) {
                console.error("Error loading full activity:", error);
                listEl.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px 0;">Could not load history.</p>';
            } finally {
                hideLoadingSpinner();
            }
        }
        
    </script>

</body>
</html>
